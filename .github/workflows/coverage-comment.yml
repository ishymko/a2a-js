name: Post Coverage Comment

on:
  workflow_run:
    workflows: ["Run Unit Tests"]
    types:
      - completed

permissions:
  pull-requests: write
  actions: read

jobs:
  comment:
    runs-on: ubuntu-latest
    if: >
      github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.conclusion == 'success'
    steps:
      - name: Download Coverage Artifacts
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          name: coverage-data
      
      - name: Post Comment
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');

            // Helper to load JSON
            const loadSummary = (path) => {
              try {
                return JSON.parse(fs.readFileSync(path, 'utf8'));
              } catch (e) {
                console.log(`Could not read ${path}: ${e}`);
                return null;
              }
            };

            const mainSummary = loadSummary('./coverage-main-summary.json');
            const prSummary = loadSummary('./coverage-pr-summary.json');

            if (!mainSummary || !prSummary) {
              console.log("Missing coverage data, skipping comment.");
              return;
            }

            let markdown = `### ðŸ§ª Code Coverage\n\n`;
            
            markdown += `[â¬‡ï¸ **View Full Report**](${context.payload.workflow_run.html_url})\n\n`;
            markdown += `| Metric | Main | PR | Delta |\n`;
            markdown += `| :--- | :---: | :---: | :---: |\n`;

            const metrics = ['lines', 'statements', 'functions', 'branches'];
            const getPct = (summary, metric) => summary.total[metric].pct;

            metrics.forEach(metric => {
              const oldPct = getPct(mainSummary, metric);
              const newPct = getPct(prSummary, metric);
              const diff = (newPct - oldPct).toFixed(2);
              
              let icon = '';
              if (diff > 0) icon = 'ðŸŸ¢';
              else if (diff < 0) icon = 'ðŸ”´';
              else icon = 'âšªï¸';

              const diffStr = diff > 0 ? `+${diff}%` : `${diff}%`;
              markdown += `| **${metric}** | ${oldPct}% | ${newPct}% | ${icon} ${diffStr} |\n`;
            });

            markdown += `\n_Generated by [unit-tests.yml](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/workflows/unit-tests.yml)_`;

            console.log(context.payload)
            const prNumber = context.payload.workflow_run.pull_requests[0]?.number;

            if (!prNumber) {
              console.log("No PR number found in workflow_run payload.");
              return;
            }

            const { owner, repo } = context.repo;

            const comments = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number: prNumber,
            });

            const existingComment = comments.data.find(c => 
              c.body.includes('Generated by [unit-tests.yml]') && 
              c.user.type === 'Bot'
            );

            if (existingComment) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existingComment.id,
                body: markdown
              });
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: prNumber,
                body: markdown
              });
            }